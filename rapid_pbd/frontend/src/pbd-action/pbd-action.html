<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-pages/iron-pages.html">
<link rel="import" href="../../bower_components/paper-dropdown-menu/paper-dropdown-menu.html">
<link rel="import" href="../../bower_components/paper-icon-button/paper-icon-button.html">
<link rel="import" href="../../bower_components/paper-item/paper-item.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-listbox/paper-listbox.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../shared-styles/shared-styles.html">
<link rel="import" href="../pbd-joint-angle-action/pbd-joint-angle-action.html">

<dom-module id="pbd-action">
  <template>
    <style include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }
      paper-material {
        background-color: #fff;
        padding: 10px;
        margin-top: 10px;
      }
      h4 {
        margin: 0px 0px;
      }
      paper-icon-button {
        color: var(--paper-grey-500);
      }
    </style>
    <paper-material>
      <div class="layout horizontal center">
        <h4>[[_actionDescription]]</h4>
        <div class="flex"></div>
        <paper-icon-button icon="delete" on-tap="_delete"></paper-icon-button>
        <paper-icon-button icon="expand-less" hidden$="[[!_isCollapseOpen]]" on-tap="toggleCollapse"></paper-icon-button>
        <paper-icon-button icon="expand-more" hidden$="[[_isCollapseOpen]]" on-tap="toggleCollapse"></paper-icon-button>
      </div>
      <iron-collapse id="collapse" opened="[[_isCollapseOpen]]">
        <paper-dropdown-menu label="Action type">
          <paper-listbox class="dropdown-content" attr-for-selected="data-type" selected="{{_displayActionType}}">
            <paper-item data-type="open gripper">Open gripper</paper-item>
            <paper-item data-type="close gripper">Close gripper</paper-item>
            <paper-item data-type="move to cartesian goal">Move to gripper pose</paper-item>
            <paper-item data-type="move to joint goal">Move to joint angles</paper-item>
            <paper-item data-type="detect tabletop objects">Detect tabletop objects</paper-item>
            <paper-item data-type="find custom landmark">Find custom landmark</paper-item>
          </paper-listbox>
        </paper-dropdown-menu>
        <iron-pages attr-for-selected="data-type" selected="[[action.type]]">
          <section data-type="actuate gripper">
            <paper-dropdown-menu label="Gripper">
              <paper-listbox class="dropdown-content" attr-for-selected="data-actuator-group" selected="{{action.actuator_group}}">
                <paper-item data-actuator-group="left gripper">Left gripper</paper-item>
                <paper-item data-actuator-group="right gripper">Right gripper</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </section>
          <section data-type="move to cartesian goal">
            <paper-dropdown-menu label="Arm to move">
              <paper-listbox class="dropdown-content" attr-for-selected="data-actuator-group" selected="{{action.actuator_group}}">
                <paper-item data-actuator-group="left arm">Left arm</paper-item>
                <paper-item data-actuator-group="right arm">Right arm</paper-item>
              </paper-listbox>
            </paper-dropdown-menu>
          </section>
          <section data-type="move to joint goal">
            <pbd-joint-angle-action action="{{action}}" ros="[[ros]]"></pbd-joint-angle-action>
          </section>
          <section data-type="detect tabletop objects">
            Tabletop detection options
          </section>
          <section data-type="find custom landmark">
            CustomLandmarks options
          </section>
        </iron-pages>
      </iron-collapse>
    </paper-material>
  </template>
  <script>
    Polymer({
      is: 'pbd-action',

      properties: {
        action: {
          notify: true,
          type: Object,
        },
        index: Number,
        ros: Object,
        _isCollapseOpen: {
          type: Boolean,
          value: true,
        },
      },

      observers: [
        '_computeActionDescription(action.*, index)',
        '_displayActionTypeChanged(_displayActionType)',
        '_actionTypeChanged(action.type)',
      ],

      toggleCollapse: function() {
        this._isCollapseOpen = !this._isCollapseOpen;
      },

      _computeActionDescription(changeRecord, index) {
        this._actionDescription = 'Action ' + (index+1);
        if (this.action.type === 'move to cartesian goal' || this.action.type === 'move to joint goal') {
          this._actionDescription = 'Move arm';
          if (this.action.actuator_group === 'arm' || this.action.actuator_group === 'left arm' || this.action.actuator_group === 'right arm') {
            this._actionDescription = 'Move ' + this.action.actuator_group;
          }
        } else if (this.action.type === 'actuate gripper') {
          var action = 'Actuate';
          var actuator = 'gripper';
          if (this.action.gripper_command.position > 0) {
            action = 'Open';
          } else {
            action = 'Close';
          }
          if (this.action.actuator_group === 'gripper'
              || this.action.actuator_group === 'left gripper'
              || this.action.actuator_group === 'right gripper') {
            actuator = this.action.actuator_group;
          }
          this._actionDescription = action + ' ' + actuator;
        } else if (this.action.type === 'detect tabletop objects') {
          this._actionDescription = 'Detect tabletop objects';
        } else if (this.action.type === 'find custom landmark') {
          this._actionDescription = 'Find custom landmark';
        }
      },


      _delete: function() {
        this.fire('delete', {index: this.index});
      },

      _displayActionTypeChanged: function(actionType) {
        if (actionType === 'open gripper') {
          this.set('action.type', 'actuate gripper');
          this.set('action.gripper_command.position', 0.1);
          this.set('action.gripper_command.max_effort', -1);
        } else if (actionType === 'close gripper') {
          this.set('action.type', 'actuate gripper');
          this.set('action.gripper_command.position', 0);
          this.set('action.gripper_command.max_effort', 100);
        } else {
          this.set('action.type', actionType);
        }
      },

      _actionTypeChanged: function(actionType) {
        if (actionType === 'actuate gripper') {
          if (this.action.gripper_command.position > 0) {
            this._displayActionType = 'open gripper';
          } else {
            this._displayActionType = 'close gripper';
          }
        } else {
          this._displayActionType = actionType;
        }
      },
    });
  </script>
</dom-module>
