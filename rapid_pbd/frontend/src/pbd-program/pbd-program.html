<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-icons/av-icons.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/ros-action-client/ros-action-client.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../../bower_components/ros-rviz/ros-rviz.html">
<link rel="import" href="../pbd-step/pbd-step.html">
<link rel="import" href="../shared-styles/shared-styles.html">

<dom-module id="pbd-program">
  <template>
    <style include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
        height: 100%;
      }
      #layout {
        height: 100%;
      }
      a {
        color: #000;
        text-decoration: none;
      }
      .add {
        height: 25px;
        padding: 5px 5px;
        line-height: 14px;
        margin-bottom: 5px;
      }
      paper-button.back {
        height: 40px;
      }
      paper-button.back:hover {
        background-color: transparent;
      }
      .step {
        background-color: var(--paper-grey-300);
        padding: 5px 5px;
        line-height: 14px;
        margin-bottom: 5px;
        min-width: 25px;
      }
      .steps > span {
        margin-right: 5px;
      }
      .step.iron-selected {
        background-color: var(--paper-grey-400);
      }
      .step:hover {
        background-color: var(--paper-grey-400);
      }
      .runstop {
        color: #fff;
        margin-left: 10px;
        height: 40px;
      }
      .run {
        background-color: var(--paper-green-500);
      }
      .stop {
        background-color: var(--paper-red-500);
      }
      .stepDiv {
        min-width: 350px;
        margin-bottom: 10px;
        overflow-y: auto;
        padding-left: 2px;
        padding-right: 2px;
        padding-bottom: 2px;
      }
      #rviz {
        height: 500px;
      }
      @media (min-width: 768px) {
        #layout {
          @apply(--layout-vertical);
        }
        .content {
          @apply(--layout-horizontal);
        }
        .stepDiv {
          width: 350px;
          max-height: 100%;
          margin-bottom: 0px;
          margin-right: 10px;
        }
        #rviz {
          height: 100%;
          width: 350px;
          @apply(--layout-flex);
        }
      }
    </style>
    <app-route
      route="{{route}}"
      pattern="/:id"
      data="{{routeData}}"
    ></app-route>
    <ros-topic
      id="programSub"
      last-message="{{program}}"
      msg-type="rapid_pbd_msgs/Program"
      topic="rapid_pbd/program/{{routeData.id}}"
      ros="[[ros]]"
    ></ros-topic>
    <ros-topic auto
      id="eventPub"
      msg-type="rapid_pbd_msgs/EditorEvent"
      topic="rapid_pbd/editor_events"
      ros="[[ros]]"
    ></ros-topic>
    <ros-action-client
      id="programAction"
      ros="[[ros]]"
      server="/rapid_pbd/execute_program_action"
      action-type="rapid_pbd_msgs/ExecuteProgramAction"
      on-feedback="_handleFeedback"
    ></ros-action-client>
    <ros-topic auto
      last-message="{{isRunning}}"
      msg-type="std_msgs/Bool"
      topic="rapid_pbd/is_running"
      ros="[[ros]]"
    ></ros-topic>
    <div id="layout">
      <div class="layout horizontal center">
        <a href="#/" class="self-end"><paper-button class="back clear"><iron-icon icon="arrow-back"></iron-icon> Back</paper-button></a>
        <paper-input class="flex" label="Program name" value="{{program.name}}" on-blur="save"></paper-input>
        <paper-button class="runstop run" hidden$="[[isRunning.data]]" raised on-tap="run">
          <iron-icon icon="av:play-arrow"></iron-icon>
          Run
        </paper-button>
        <paper-button class="runstop stop" hidden$="[[!isRunning.data]]" raised on-tap="stop">
          <iron-icon icon="av:stop"></iron-icon>
          Stop
        </paper-button>
      </div>
      <div class="steps layout horizontal center">
        <span>Steps: </span>
        <span hidden$="[[_hasSteps(program.steps)]]">None</span>
        <iron-selector attr-for-selected="name" selected="{{currentStepNum}}">
          <template is="dom-repeat" id="stepList" items="[[program.steps]]" >
            <paper-button class="step" name="[[index]]" on-tap="selectStep">{{_stepNum(index)}}</paper-button>
          </template>
        </iron-selector>
        <paper-button class="add important" on-tap="addStep">+ Add Step</paper-button>
      </div>
      <div class="content flex">
        <array-selector id="selector" items="{{program.steps}}" selected="{{currentStep}}"></array-selector>
        <div class="stepDiv" hidden$="[[!_hasSteps(program.steps)]]"><div class="stepDivInner">
          <pbd-step
            index="[[currentStepNum]]"
            step="{{currentStep}}"
            ros="[[ros]]"
            on-save="save"
            on-delete="_deleteStep"
          ></pbd-step>
          </div></div>
        <ros-rviz id="rviz" global-options="{{globalOptions}}" ros="[[ros]]"></ros-rviz>
      </div>
    </div>
  </template>

  <script>
    Polymer({
      is: 'pbd-program',

      properties: {
        currentStepNum: {
          type: Number,
          value: 0,
        },
        program: {
          type: Object,
          observer: '_programChanged',
        },
        ros: Object,
        route: Object,
        isRunning: {
          type: Object,
          value: function() {
            return { data: false };
          }
        },
      },

      observers: [
        'load(ros, routeData.id)',
        '_stepChanged(ros, routeData.id, currentStepNum)',
        '_currentStepNumChanged(program, currentStepNum)',
      ],

      load: function(ros, db_id) {
        if (!db_id || !ros) {
          return;
        }
        this.$.programSub.subscribe();
        this.currentStepNum = 0;

				var config = {
          globalOptions: {
            fixedFrame: '/base_link',
          },
          displays: [
            {
              isShown: true,
              name: 'Grid',
              type: 'grid',
              options: {
                cellSize: 1,
                color: '#cccccc',
                numCells: 20,
              },
            }, {
              isShown: true,
              name: 'Robot model',
              type: 'markerArray',
              options: {
                topic: '/rapid_pbd/robot/' + db_id,
              },
            },
          ],
          sidebarOpened: false,
        };
        if (this.$.rviz) {
          this.$.rviz.loadConfig(config);
        } else {
          console.log('rviz not ready');
        }
      },

      save: function() {
        var cleanProgram = this._cleanProgram();
        var msg = {
          type: 'update program',
          program_info: {
            db_id: this.routeData.id,
            name: this.program.name,
          },
          program: cleanProgram
        };
        console.debug('Saving', cleanProgram);
        this.$.eventPub.publish(msg);
      },

      run: function() {
        var cleanProgram = this._cleanProgram();
        var goal = {
          program: cleanProgram
        }
        this.$.programAction.send(goal);
      },

      stop: function() {
        this.$.programAction.cancel();
      },

      // Removes unused parameters from the message.
      // Ideally, we would do this within pbd-action, but that leads to
      // infinite looping.
      _cleanProgram: function() {
        if (!this.program.steps) {
          return;
        }
        var cleanProgram = {
          name: this.program.name,
          steps: [],
          start_joint_state: this.program.start_joint_state
        };
        for (var stepi=0; stepi<this.program.steps.length; ++stepi) {
          var step = this.program.steps[stepi];
          var cleanStep = {
            actions: [],
            scene_id: step.scene_id,
            landmarks: step.landmarks
          };
          for (var ai=0; ai<step.actions.length; ++ai) {
            var action = step.actions[ai];
            var cleanAction = {};
            if (action.type === 'actuate gripper') {
              cleanAction = {
                type: action.type,
                actuator_group: action.actuator_group,
                gripper_command: action.gripper_command
              };
            } else if (action.type === 'move to cartesian goal') {
              cleanAction = {
                type: action.type,
                actuator_group: action.actuator_group,
                pose: action.pose,
                landmark: action.landmark,
                control_strategy: action.control_strategy
              };
            } else if (action.type === 'move to joint goal') {
              cleanAction = {
                type: action.type,
                actuator_group: action.actuator_group,
                joint_trajectory: action.joint_trajectory,
                control_strategy: action.control_strategy
              };
            } else if (action.type === 'detect tabletop objects') {
              cleanAction = {
                type: action.type
              }
            } else if (action.type === 'detect tabletop objects') {
              cleanAction = {
                type: action.type
              }
            } else {
            }
            cleanStep.actions.push(cleanAction);
          }
          cleanProgram.steps.push(cleanStep);
        }
        return cleanProgram;
      },

      addStep: function() {
        var step = { actions: [] };
        this.push('program.steps', step);
        this.currentStepNum = this.program.steps.length-1;
        this.save();
      },

      selectStep: function(e) {
        var step = this.$.stepList.itemForElement(e.target);
        this.currentStepNum = parseInt(e.target.name);
      },

      _deleteStep: function(evt) {
        this.splice('program.steps', this.currentStepNum, 1);
        this.currentStepNum = Math.max(this.currentStepNum-1, 0);
        this.save();
        evt.stopPropagation(); 
      },

      // If a new program is loaded, select step 0.
      _programChanged: function(program, oldProgram) {
        if (!program) {
          return;
        }
        if (program.steps.length > 0) {
          this.$.selector.select(program.steps[0]);
        }
      },

      _hasSteps: function(steps) {
        return steps && steps.length > 0;
      },

      _currentStepNumChanged: function(program, currentStepNum) {
        if (program && program.steps) {
          this.$.selector.select(program.steps[currentStepNum]);
        }
      },

      _stepChanged(ros, db_id, currentStepNum) {
        if (!ros || !db_id || (!currentStepNum && currentStepNum !== 0)) {
          return;
        }
        console.log('publishing view ', currentStepNum);
        var msg = {
          type: 'view step',
          program_info: {
            db_id: db_id
          },
          step_num: currentStepNum
        };
        this.$.eventPub.publish(msg);
      },

      _stepNum: function(index) {
        return parseInt(index) + 1;
      },

      _handleFeedback: function(evt) {
        this.currentStepNum = evt.detail.step_number;
      },
    });
  </script>
</dom-module>
