<link rel="import" href="../../bower_components/polymer/polymer.html">
<link rel="import" href="../../bower_components/app-route/app-route.html">
<link rel="import" href="../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../bower_components/iron-icon/iron-icon.html">
<link rel="import" href="../../bower_components/iron-icons/iron-icons.html">
<link rel="import" href="../../bower_components/iron-collapse/iron-collapse.html">
<link rel="import" href="../../bower_components/iron-selector/iron-selector.html">
<link rel="import" href="../../bower_components/paper-button/paper-button.html">
<link rel="import" href="../../bower_components/paper-dialog/paper-dialog.html">
<link rel="import" href="../../bower_components/paper-material/paper-material.html">
<link rel="import" href="../../bower_components/paper-styles/color.html">
<link rel="import" href="../../bower_components/ros-topic/ros-topic.html">
<link rel="import" href="../pbd-step/pbd-step.html">
<link rel="import" href="../shared-styles/shared-styles.html">

<dom-module id="pbd-program">
  <template>
    <style include="shared-styles"></style>
    <style is="custom-style" include="iron-flex iron-flex-alignment"></style>
    <style>
      :host {
        display: block;
      }
      a {
        color: #000;
        text-decoration: none;
      }
      .add.step {
        background-color: var(--paper-amber-500);
      }
      .steps {
        margin-bottom: 5px;
      }
      .step {
        background-color: var(--paper-grey-300);
        padding: 5px 5px;
        line-height: 14px;
        min-width: 25px;
      }
      .steps > span {
        margin-right: 5px;
      }
      .step.iron-selected {
        background-color: var(--paper-grey-400);
      }
      .step:hover {
        background-color: var(--paper-grey-400);
      }
      .delete {
        color: var(--paper-red-500);
      }
      paper-material {
        background-color: #fff;
        padding: 5px;
      }
      paper-material h3 {
        margin: auto 0px;
        display: inline-block;
      }
      paper-material .title {
        border-bottom: 1px solid var(--paper-grey-300);
        margin-bottom: 10px;
      }
    </style>
    <app-route
      route="{{route}}"
      pattern="/:id"
      data="{{routeData}}"
    ></app-route>
    <ros-topic
      id="programSub"
      last-message="{{program}}"
      msg-type="rapid_pbd_msgs/Program"
      topic="rapid_pbd/program/{{routeData.id}}"
      ros="[[ros]]"
    ></ros-topic>
    <ros-topic auto
      id="eventPub"
      msg-type="rapid_pbd_msgs/EditorEvent"
      topic="rapid_pbd/editor_events"
      ros="[[ros]]"
    ></ros-topic>
    <div class="layout horizontal">
      <a href="#/" class="self-end"><paper-button><iron-icon icon="arrow-back"></iron-icon> Back</paper-button></a>
      <paper-input class="flex" label="Program name" value="{{program.name}}" on-blur="save"></paper-input>
    </div>
    <div class="steps layout horizontal">
      <span>Steps: </span>
      <span hidden$="[[_hasSteps(program.steps)]]">None</span>
      <iron-selector attr-for-selected="name" selected="{{currentStepNum}}">
        <template is="dom-repeat" id="stepList" items="[[program.steps]]" >
          <paper-button class="step" name="[[index]]" on-tap="selectStep">{{_stepNum(index)}}</paper-button>
        </template>
      </iron-selector>
      <paper-button class="add step" on-tap="addStep">+</paper-button>
    </div>
    <div>
      <array-selector id="selector" items="{{program.steps}}" selected="{{currentStep}}"></array-selector>
      <paper-material hidden$="[[!_hasSteps(program.steps)]]">
        <div class="horizontal layout title">
          <h3>Step [[_stepNum(currentStepNum)]]</h3>
          <span class="flex"></span>
          <paper-button class="delete" on-tap="_maybeDeleteCurrentStep">Delete</paper-button>
        </div>
        <pbd-step step="{{currentStep}}"></pbd-step>
      </paper-material>
    </div>
    <paper-dialog id="deleteDialog" modal>
      <h2>Delete step [[_stepNum(currentStepNum)]]?</h2>
      <div class="deleteButtons">
        <paper-button dialog-dismiss>Cancel</paper-button>
        <paper-button dialog-confirm on-tap="deleteCurrentStep" class="delete">Delete</paper-button>
      </div>
    </paper-dialog>
  </template>

  <script>
    Polymer({
      is: 'pbd-program',

      properties: {
        currentStepNum: {
          type: Number,
          value: 0,
        },
        program: {
          type: Object,
          observer: '_programChanged',
        },
        ros: Object,
        route: Object,
      },

      observers: [
        'load(ros, routeData.id)',
        '_programUpdated(program.*)',
        '_currentStepNumChanged(program, currentStepNum)',
      ],

      load: function(ros, db_id) {
        if (!db_id || !ros) {
          return;
        }
        var that = this;
        this.debounce('load program', function() {
          var msg = {
            action: 'open program',
            program_info: {
              db_id: db_id
            },
          };
          that.$.eventPub.publish(msg);
          that.$.programSub.subscribe();
        }, 100);
      },

      save: function() {
        var msg = {
          action: 'update program',
          program_info: {
            db_id: this.routeData.id,
            name: this.program.name,
          },
          program: this.program
        };
        this.$.eventPub.publish(msg);
      },

      addStep: function() {
        var step = { actions: [] };
        this.push('program.steps', step);
        this.currentStepNum = this.program.steps.length-1;
      },

      selectStep: function(e) {
        var step = this.$.stepList.itemForElement(e.target);
        this.currentStepNum = parseInt(e.target.name);
      },

      deleteCurrentStep: function() {
        this.splice('program.steps', this.currentStepNum, 1);
        this.currentStepNum = Math.max(this.currentStepNum-1, 0);
      },

      _maybeDeleteCurrentStep: function() {
        this.$.deleteDialog.open();
      },

      _programChanged: function(program, oldProgram) {
        if (!program) {
          return;
        }
        if (program.steps.length === 0) {
        } else {
          this.$.selector.select(program.steps[0]);
        }
      },

      _programUpdated: function(changeRecord) {
        if (changeRecord.base) {
          if (changeRecord.path !== 'program') {
            this.save();
          }
        }
      },

      _hasSteps: function(steps) {
        return steps && steps.length > 0;
      },

      _stepNum: function(index) {
        return parseInt(index) + 1;
      },

      _currentStepNumChanged: function(program, currentStepNum) {
        if (program && program.steps) {
          this.$.selector.select(program.steps[currentStepNum]);
        }
      },
    });
  </script>
</dom-module>
